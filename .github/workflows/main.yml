# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. 
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch: {}
  pull_request: {}

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: Setup Ruby, JRuby and TruffleRuby
        uses: ruby/setup-ruby@v1.72.1
      - name: Create files
        run: |
          cd /tmp
          wget https://dl.influxdata.com/platform/nightlies/influx_nightly_linux_amd64.tar.gz
          tar xvfz influx_nightly_linux_amd64.tar.gz || true
          sudo cp influx_nightly_linux_amd64/{influx,influxd} /usr/local/bin/
          influxd --http-bind-address :8086 --reporting-disabled > /dev/null 2>&1 &
          until curl -s http://localhost:8086/health; do sleep 1; done
          influx setup --host http://localhost:8086 -f -b dummy -o influxdata -u ci_user -p password
          cd $GITHUB_WORKSPACE/air-sensor-data
          ruby ./air-sensor-data.rb > air-sensor-data.lp
          /usr/local/bin/influx write -f ./air-sensor-data.lp -b dummy
          /usr/local/bin/influx query "from(bucket: \"dummy\") |> range(start: -1y)" --raw > ./air-sensor-data-annotated.csv
      - name: Commit changes
        uses: EndBug/add-and-commit@v7
        with:
          author_name: Russ Savage
          author_email: russ@influxdata.com
          message: 'Adding LP and annotated CSV file'
